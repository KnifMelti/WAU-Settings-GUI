name: Update Release Download Stats

on:
  schedule:
    - cron: '0 4 * * *' # 07:00 Swedish summer time (# 06:00 Swedish winter time)
  workflow_dispatch:

jobs:
  update-stats:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Update Release Stats
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        shell: bash
        run: |
          releases=$(curl -s -H "Authorization: Bearer $GITHUB_TOKEN" \
            "https://api.github.com/repos/${{ github.repository }}/releases?per_page=20")
          
          # Deduplicate releases by ID before processing
          unique_releases=$(echo "$releases" | jq 'unique_by(.id)')
          
          echo "$unique_releases" | jq -c '.[]' | while read -r release; do
            release_id=$(echo "$release" | jq -r '.id')
            tag_name=$(echo "$release" | jq -r '.tag_name')
            current_body=$(echo "$release" | jq -r '.body // ""')
            
            total_downloads=$(echo "$release" | jq '[.assets[].download_count] | add // 0')
            
            # Remove any existing statistics section (handles both ASCII and Unicode variants)
            # This uses a more flexible pattern that works with encoding issues
            clean_body=$(echo "$current_body" | sed -E '/## .* Download Statistics/,$d')
            
            # Remove trailing whitespace and newlines
            clean_body=$(echo "$clean_body" | sed -e :a -e '/^\s*$/d;N;ba')
            
            # Build the new body with proper statistics section
            stats_section="\n\n## ðŸ“¥ Download Statistics\n\nEarly Swedish Mornings Totals **(ESMT): $total_downloads**"
            
            # Combine and escape for JSON
            new_body="${clean_body}${stats_section}"
            escaped_body=$(printf '%s' "$new_body" | jq -Rs .)
            
            # Update the release
            curl -s -X PATCH \
              -H "Authorization: Bearer $GITHUB_TOKEN" \
              -H "Content-Type: application/json" \
              "https://api.github.com/repos/${{ github.repository }}/releases/$release_id" \
              -d "{\"body\":$escaped_body}"
            
            echo "Updated $tag_name (Downloads: $total_downloads)"
          done
