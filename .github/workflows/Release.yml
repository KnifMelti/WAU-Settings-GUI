name: Create Release
on:
  release:
    types: [published]
permissions:
  contents: write
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Create release package
      run: |
        # Create structure that matches development environment
        # ProjectRoot/
        #   Sources/
        #     WAU Settings GUI/
        #       WAU-Settings-GUI.ps1
        #   shared/
        #     SandboxTest.ps1
        
        mkdir -p release-package/Sources/WAU\ Settings\ GUI
        mkdir -p release-package/shared
        
        # Copy main files (excluding build scripts and old SandboxTest.ps1)
        cd "Sources/WAU Settings GUI"
        find . -type f ! -name "compile_and_sign.ps1" ! -name "sign_exe.ps1" ! -name "SandboxTest.ps1" -exec cp --parents {} ../../release-package/Sources/WAU\ Settings\ GUI/ \;
        cd ../..
        
        # Copy SandboxTest.ps1 from shared submodule to the root of Sources/WAU Settings GUI
        cp shared/SandboxTest.ps1 release-package/Sources/WAU\ Settings\ GUI/
        
        # Create zip from contents (without extra parent directory)
        cd release-package
        zip -r "../WAU-Settings-GUI-${{ github.event.release.tag_name }}.zip" .
        cd ..
    
    - name: Upload Release Asset
      uses: softprops/action-gh-release@v1
      with:
        files: ./WAU-Settings-GUI-${{ github.event.release.tag_name }}.zip
        token: ${{ secrets.GITHUB_TOKEN }}
