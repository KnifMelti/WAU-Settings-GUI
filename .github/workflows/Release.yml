name: Create Release
on:
  release:
    types: [published]
permissions:
  contents: write
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        submodules: recursive
    
    - name: Create release package
      run: |
        # Create flat structure with files directly in root
        # release-package/
        #   WAU-Settings-GUI.ps1
        #   SandboxTest.ps1
        #   Show-SandboxTestDialog.ps1
        #   config/
        #   modules/
        #   ...

        mkdir -p release-package

        # Copy main files (excluding build scripts and files from shared submodule)
        cd "Sources/WAU Settings GUI"
        find . -type f ! -name "compile_and_sign.ps1" ! -name "sign_exe.ps1" ! -name "SandboxTest.ps1" ! -name "Shared-Helpers.ps1" ! -name "Show-SandboxTestDialog.ps1" -exec cp --parents {} ../../release-package/ \;
        cd ../..

        # Ensure proper line endings for submodule files
        # The .gitattributes in the submodule enforces CRLF, so we ensure it's applied
        cd Sources/shared
        git config core.autocrlf true
        git checkout --force HEAD
        cd ../..

        # Copy shared submodule files to the root (now with correct line endings)
        cp Sources/shared/SandboxTest.ps1 release-package/
        cp Sources/shared/Shared-Helpers.ps1 release-package/
        cp Sources/shared/Show-SandboxTestDialog.ps1 release-package/
        
        # Create zip from contents (without extra parent directory)
        cd release-package
        zip -r "../WAU-Settings-GUI-${{ github.event.release.tag_name }}.zip" .
        cd ..
    
    - name: Upload Release Asset
      uses: softprops/action-gh-release@v1
      with:
        files: ./WAU-Settings-GUI-${{ github.event.release.tag_name }}.zip
        token: ${{ secrets.GITHUB_TOKEN }}
